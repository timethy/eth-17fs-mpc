\documentclass[landscape,a4paper,8pt]{scrartcl}

\usepackage{bm}
\usepackage{layout}
\usepackage{changepage}   % for the adjustwidth environment
\usepackage{booktabs}
%\usepackage{extsizes}
%\usepackage{savetrees}
\usepackage{xargs} 
\usepackage{graphicx,xcolor} 
\usepackage[bordercolor=white,backgroundcolor=gray!30,linecolor=black,colorinlistoftodos]{todonotes}
\newcommandx{\tim}[1]{\todo[color=blue!30, inline]{tim: {#1}}}

%------------------------------------
%  FOOTER SETTINGS
%------------------------------------
\pagestyle{fancy}
\renewcommand{\headrulewidth}{0pt}
\fancyhead{}
\renewcommand{\footrulewidth}{0pt}
\fancyfoot[L]{Tim Taubner (taubnert@ethz.ch)}
\fancyfoot[C]{Model Predictive Control - \today}
\fancyfoot[RO, LE] {\thepage}

\newcommand{\remph}[1]{{\textcolor{red}{#1}}}
\newcommand{\mc}[1]{\mathcal{#1}}
\newcommand\va{\bm{a}}
\newcommand\vq{\bm{q}}
\newcommand\vr{\bm{r}}
\newcommand\vp{\bm{p}}
\newcommand\vk{\bm{k}}
\newcommand\vn{\bm{n}}
\newcommand\vv{\bm{v}}
\newcommand\vx{\bm{x}}
\newcommand\vy{\bm{y}}
\newcommand\vz{\bm{z}}
\newcommand\vA{\bm{A}}
\newcommand\vB{\bm{B}}
\newcommand\vC{\bm{C}}
\newcommand\vD{\bm{D}}
\newcommand\vE{\bm{E}}
\newcommand\vF{\bm{F}}
\newcommand\vG{\bm{G}}
\newcommand\vH{\bm{H}}
\newcommand\vI{\bm{I}}
\newcommand\vK{\bm{K}}
\newcommand\vP{\bm{P}}
\newcommand\vQ{\bm{Q}}
\newcommand\vR{\bm{R}}
\newcommand\vS{\bm{S}}
\newcommand\vT{\bm{T}}
\newcommand\vU{\bm{U}}
\newcommand\vV{\bm{V}}
\newcommand\vW{\bm{W}}
\newcommand\vX{\bm{X}}
\newcommand\vY{\bm{Y}}
\newcommand\vZ{\bm{Z}}

\newcommand{\Mn}[1]{\begin{pmatrix}#1\end{pmatrix}} %normale Klammern, normal bracket
\newcommand{\Mo}[1]{\begin{matrix}#1\end{matrix}} %ohne Klammern, no brackets
\newcommand{\Me}[1]{\begin{bmatrix}#1\end{bmatrix}} %eckige Klammern
\newcommand{\Mg}[1]{\begin{Bmatrix}#1\end{Bmatrix}} %geschweifte Klammern

\DeclareMathOperator\diag{diag}
\DeclareMathOperator\rank{rank}
\DeclareMathOperator\dom{dom}
\DeclareMathOperator\size{size}

%------------------------------------
%  BEGIN DOCUMENT
%------------------------------------

\begin{document}
%\sffamily

%--CONTENT--
\begin{multicols*}{3}
\section{Systems Theory}
\subsection{Linearization}
\subsection{Discretization}
\paragraph{Exact}
\paragraph{Forward-Euler}
\paragraph{Backward-Euler}
\subsection{Lyapunov Function}
$V(0) = 0$, $x \neq 0 \implies V(x) > 0$, $V(g(x(k+1))) - V(x(k+1)) \leq - \alpha(x(k))$

System asymptotically stable if $V(x)$ exists.
Globally stable iff $\lVert x \rVert \rightarrow \infty \implies V(x) \rightarrow \infty$.

Check Eig. values of $(APA-P)$ neg., $V(x) = x^TPx$ ?

\section{Unconstrained Control}
\subsection{Block Approach (used also for $\bar w$ substition)}
\begin{align*}
		\Me{x_0 \\ x_1 \\ \vdots \\ x_N } & = \Me{\vI \\ \vA \\ \vdots \\ \vA^N}x(0) + \Me{\bm 0 & \bm 0 & \dots & \bm 0 \\ \vB & \bm 0 & \dots & \bm 0 \\ \vA\vB & \vB & \dots & \bm 0 \\ \vdots & \vdots & \ddots & \bm 0 \\ \vA^{N-1}\vB & \dots & \vA\vB & \vB}\Me{u_0 \\ u_1 \\ \vdots \\ u_{N_1}}
\end{align*}

\begin{align*}
x & = \vS^x\cdot x(0) + \vS^u\cdot u & \size(\vS^x) & = \left[ n_\text{states} \cdot (N+1) , N \right] \\
  &                                  & \size(\vS^u) & = \left[ n_\text{states} \cdot (N+1), n_\text{states} \right] \\
\bar\vQ & = \diag(\vQ,\dots,\vQ, \vP) & \size(\bar\vQ) & = \left[ n_\text{states} \cdot (N+1), n_\text{states} \cdot (N+1) \right] \\
\bar\vR & = \diag(\vR,\dots,\vR) & \size(\bar\vR) & = (n_\text{input}\cdot N, n_\text{input}\cdot N) \\
\vH & = {\vS^u}^T\bar\vQ\vS^u + \vR & \vF & = {\vS^x}^T\bar\vQ\vS^u \\
\vY & = {\vS^x}^T\bar\vQ\vS^x
\end{align*}
\paragraph{Optimal cost and control}
%\quad \nabla_{u_0}J^*(x_0) \mbeq 0 \text{ gives} \\
\begin{align*}
J^*(x_0) & = -x_0^T \vF\vH\vF^T x_0 + x_0^T \vY x_0 \\
u^*(x_0) & = -\vH^{-1}\vF^T x_0 = - \left( {\vS^u}^T\bar\vQ\vS^u + \vR \right)^{-1}{\vS^u}^T\bar\vQ\vS^x x_0 \\
\end{align*}

\subsection{Recursive Approach}
\begin{align*}
J_k^*(x_k) & = \min_{u_k} I(x_k, u_k) + J_{k+1}(x_{k+1})
\end{align*}
Is a feedback controller as opposed to the Batch Approach.
For LQR solve via Riccati Difference Equation (RDE).
\begin{align*}
 \vF_k & = -(\vB^T\vP_\remph{k+1}\vB + \vR)^{-1}\vB^T\vP_\remph{k+1}\vA \\
 \vP_k & = \vA^T\vP_\remph{k+1}\vA + \vQ - \vA^T\vP_\remph{k+1}\vB(\vB^T\vP_\remph{k+1}\vB + \vR)^{-1}\vB^T\vP_\remph{k+1}\vA
\end{align*}
\begin{align*}
 u_k^* & = \vF_k\ x_k  & J_k^*(x_k) & = x_k^T\vP_k\ x_k & \vP_N & = \vP
\end{align*}
For unconstrained Infinite Horizon Problem, substituting $\vP_\infty = \vP_k = \vP_{k+1}$ into RDE gives DARE.
Uniquely solvable, iff $(A,B)$ stabilizable and $(A, G)$ detectable, where $\vG\vG^T = \vQ$.
Follows from closed-loop system $x_{k+1} = (\vA + \vB\vF_k)x_k$

\section{(Convex) Optimization}

\paragraph{General Problem}
$\min_{x \in \dom(f)} f(x)$ s.\ t.\ $g_i(x) \leq 0$ and $h_j(x) = 0.$
%for $i = 1,\dots,m, j = 1,\dots,p$.

\paragraph{RHC}
\paragraph{QP with substitution (see also Batch approach)}
\begin{align*}
J^*(x_k) & = \min_u \Me{u^T & x_k^T}\Me{\vH & \vF^T \\ \vF & \vY}\Me{u \\ x_k} \\
\text{s. t. } & \vG\ u \leq w + \vE\ x_k
\end{align*}
Latter gives three sets (same for without substitution)
\begin{align*}
\mc{X}   & = \{ x | A_x\ x \leq b_x\} \\
\mc{U}   & = \{ u | A_u\ u \leq b_u\} \\
\mc{X_f} & = \{ x | A_f\ x \leq b_f\} \\
\end{align*}
State equations are in cost matrix, usually $\vA_x = \Me{1 \\ -1}, b_x = \Me{b_\text{max} \\ -b_\text{min}}$
\begin{scriptsize}
\setlength{\arraycolsep}{2pt}
\begin{align*}
\vG & = \Me{\vA_u & 0 & \dots & 0 \\
          0 & \vA_u & \dots & 0 \\
          \vdots & \vdots & \ddots & \vdots \\
					0      & 0 & \dots & \vA_u \\
					0      & 0 & \dots & 0 \\
					\vA_x\vB & 0 & \dots & 0 \\
					\vA_x\vA\vB & \vA_x\vB & \dots & 0 \\
					\vdots & \vdots & \ddots & \vdots \\
					\vA_x\vA^{N-2}\vB & \vA_x\vA^{N-3}\vB & \dots & 0 \\
					\vA_f\vA^{N-1}\vB & \vA_f\vA^{N-2}\vB & \dots & \vA_f\vB} &
\vE & = \Me{0 \\ 0 \\ \vdots \\ 0 \\ -\vA_x \\ -\vA_x\vA \\ -\vA_x\vA^2 \\ \vdots \\ -\vA_x\vA^{N-1} \\ -\vA_f\vA^N} &
\vW & = \Me{b_u \\ b_u \\ \vdots \\ b_u \\ b_x \\ b_x \\ b_x \\ \vdots \\ b_x \\ b_f}
\end{align*}
\end{scriptsize}

\paragraph{QP with out substitution}
State equations represented in equality constrainst.
\begin{align*}
J^*(x_k) & = \min_z \Me{z^T & x_k^T}\Me{\bar\vH & \bm 0 \\ \bm 0 & \vQ}\Me{z \\ x_k} \\
\text{s. t. } & \vG\ z \leq w + \vE\ x_k \\
              & \vG_\text{eq}\ z = \vE_\text{eq}\ x_k, \quad \text{system dynamics} \\
\end{align*}
$\bar\vH = \diag(\vQ,\dots,\vQ,\vP,\vR,\dots,\vR)$
\begin{scriptsize}
\setlength{\arraycolsep}{2pt}
\begin{align*}
z & = \Me{x_1 \\ . \\ x_N \\ u_0 \\ . \\ u_{N-1}} &
\vG_\text{eq} & =
\begin{bmatrix}[rrrr@{\hskip 2pt}|@{\hskip 2pt}rrrr]
 \vI & \   &  \   & \   & -\vB &  \   & \ &  \ \\
-\vA & \vI &  \   & \   &  \   & -\vB & \ &  \ \\
 \   & .   & .    & \   &  \   &  \   & . &  \ \\
 \   & \   & -\vA & \vI &  \   &  \   & \ & -\vB
\end{bmatrix} &
\vE_\text{eq} & = \Me{\vA \\ 0 \\ . \\ 0} \\
w & = \Me{b_x \\ . \\ b_f \\ b_u \\ . \\ b_u} &
\vG & =
\begin{bmatrix}[cccc|ccc]
 0  & \     & \ & \     & \     & \ & \ \\
 \  & \vA_x & \ & \     & \     & \ & \ \\
 \  & \     & . & \     & \     & \ & \ \\
 \  & \     & \ & \vA_x & \     & \ & \ \\ \cmidrule(lr){1-7}
 \  & \     & \ & \     & \vA_d & \ & \ \\
 \  & \     & \ & \     & \     & . & \ \\
 \  & \     & \ & \     & \     &   & \vA_d
\end{bmatrix} &
\vE & = \Me{-\vA_x^T \\ 0 \\ . \\ 0}
\end{align*}
\end{scriptsize}

\subsection{Duality}
\paragraph{Lagrangian Dual Function}
\begin{align*}
	L(x,\lambda,\nu) & = f(x) + \sum_{i=1}^{m}\lambda_i g_i(x) + \sum_{i=1}^{p}\nu_i h_i(x) \\
	d(\lambda,\nu) & = \inf_{x \in \mc{X}} L(x,\lambda,\nu) \quad \text{ i.e. } \nabla_x L(x, \lambda, \nu) = 0
%	&= \inf_{x \in \mc{X}} \left[ f_0(x)+\sum_{i=1}^{m}\lambda_i f_i(x)+\sum_{i=1}^{p}\nu_i h_i(x)\right]
\end{align*}
\paragraph{Dual Problem (always convex)} 
$\max_{\lambda,\nu} d(\lambda,\nu)$ s.\ t.\ $\lambda \geq 0$. \\
Optimal value is lower bound for primal: $d^* \leq p^*$.

If primal convex, \emph{Slater condition} (strict feasibility) implies \emph{strong duality}:
\begin{align*}
	\left\{x \left| \right. Ax=b, f_i(x)<0, \right\} \neq \emptyset \Rightarrow d^*  = p^*
\end{align*}

\paragraph{Karush-Kuhn-Tucker (KKT) Conditions}
are necessary for optimality (and sufficient if primal convex).
\begin{itemize}
	\item Primal Feasibility:
		\begin{align*}
			f_i(x^*) &\leq 0 \quad i=1,\dots,m\\
			h_i(x^*) &=0 \quad i=1,\dots,p
		\end{align*}
	\item Dual Feasibility:  $\lambda^* \geq 0$
	\item Complementary Slackness:
		\begin{align*}
			\lambda_i^* \cdot f_i(x^*) = 0 \quad \quad i=1,\dots,m
		\end{align*}
	\item Stationarity:
		\begin{align*}
			&\nabla_x L(x^*,\lambda^*,\nu^*) =0 \\
			%&\nabla f_0(x^*) + \sum_{i=1}^m\lambda_i^*\nabla f_i(x^*)+  \sum_{i=1}^p\nu_i^*\nabla h_i(x^*)
		\end{align*}
\end{itemize}

\subsection{Constrained Finite Time Optimal Control (CFTOC)}

\subsection{Invariance}
\subsection{Feasability, Stability}

\subsection{Practical MPC}
\subsection{Robust MPC}
\paragraph{Tube-MPC}

\subsection{Explicit MPC}

\subsection{Hybrid MPC}

\section{Numerical Optimization}
Gradient, Newton, Interior Point


\section{Observer Based Control}
\subsection{LTI Observer}
LTI System: 
\begin{align*}
& x(k) = A x(k-1) + B u (k-1) + v(k-1) \\
& z(k) = H x(k) + w(k)
\end{align*}

Linear Static Gain Observer (Luenberger Observer):
\begin{align*}
&\hat{x}(k) = A \hat{x}(k-1) + B u (k-1) + K(z(k) - \hat{z}(k)) \\
&\hat{z}(k) = H ( A \hat{x}(k-1) + B u(k-1)) \\
&e(k)= (I-K \, H)\, A \,  e(k-1)
\end{align*}
$e(k) \to 0$ for $k \to \infty$ if and only if $(I-K \, H)\, A$ is stable.\\

Steady State: 
\begin{align*}
&\hat{x}(k) = (I-K_\infty H )\, A\, \hat{x}(k-1) + (I-K_\infty) B \, u(k-1) + K_\infty z(k)
\end{align*}
The steady-state KF is one way to design the observer gain $K$ (optimal in minimizing the Steady State mean squared error). \\

%Observer Estimation error:
%\begin{align*}
%e(k)= (I-K \, H)\, A \,  e(k-1)
%\end{align*}



%\begin{tabular}{ll}
%LTI system: & $x(k) = A x(k-1) + B u (k-1) + v(k-1)$ \\
%& $z(k) = H x(k) + w(k)$
%\end{tabular} 
%
%\begin{tabular}{ll}
%Observer: & $\hat{x}(k) = A \hat{x}(k-1) + B u (k-1) + K(z(k) - \hat{z}(k))$ \\
%& $\hat{z}(k) = H ( A \hat{x}(k-1) + B u(k-1))$
%\end{tabular}
%
%\begin{tabular}{ll}
%Steady State: & $\hat{x}(k) = (I-K_\infty H )\, A\, \hat{x}(k-1) + ... $ \\
% & $(I-K_\infty) B \, u(k-1) + K_\infty z(k)$ \\
%Estim. error: & $e(k)= (I-K \, H)\, A \,  e(k-1)$
%\end{tabular}

$(A,H)$ detectable $ \Rightarrow$ $K$ exists such that $(I-K \, H) A$ is stable.

\subsection{Static State Feedback Control}
Design of a controller without paying attention to the state estimation:
\begin{align*}
x(k) &= A x(k-1) + B u(k-1) \tag{Process without noise} \\
z(k) &= x(k)  \tag{Perfect State information} \\
u(k) &= F \cdot z(k) = F \cdot x(k) \tag{Control Law}
\end{align*}
%Control law: $u(k) = F \cdot z(k) = F \cdot x(k)$ (needs to be designed) \\

Closed loop dynamics: $x(k) = (A+B F)$. Hence system is stable if $(A+B F)$ is stable. Such an $F$ exists only if $(A,B)$ is stabilizable. \\
If $(A,B)$ is stabilizable and $(A,G)$ detectable, then $F$ is given by
\begin{align*}
F = -(B^T P B + \bar{R})^{-1} \cdot B^T P A; \qquad P\geq 0
\end{align*}
$P$ from DARE: $P = A^T P A + \bar{Q} - A^T P B( B^T P B + \bar{R})^{-1} \cdot B^T P A$

%\subsection{Linear Static Gain Observer (Luenberger Observer)}
%\begin{align*}
%\hat{x}(k) &= A \hat{x}(k-1) + B \, u(k-1) + K(z(k) - \hat{z}(k)) \\
%\hat{z}(k) &= H(A \hat{x}(k-1) + B u(k-1)) \\
%u(k) &= F \, \hat{x}(k)
%\end{align*}


\subsection{Separation Principle (Linear Systems only)}
Combining Luenberger Observer and Static State Feedback control yields:
\begin{align*}
\begin{bmatrix}
x(k) \\ e(k) 
\end{bmatrix}
= 
\begin{bmatrix}
A + BF & - B F \\ 0 & (I-KH) A
\end{bmatrix}
\cdot
\begin{bmatrix}
x(k-1) \\ e(k-1)
\end{bmatrix}
\end{align*}
Eigenvalues of closed loop are given bei Eigenvalues of $(I-KH) A$ and $(A + BF)$. System is stable as long as there exists no $|\lambda| \geq 1$. \\

%Note:
%\begin{itemize}
%\item Including noise does not affect stability.
%\item Separation principle generally does not hold for nonlinear systems.
%\end{itemize}


\subsection{Separation Theorem}
%Given a LTI System with $v(k-1) \sim \mathcal{N}(0,Q)$ and $w(k-1) \sim \mathcal{N}(0,R)$

\begin{enumerate}
\item Design steady-state KF which does not depend on $\bar{Q}, \bar{R}$. $\Rightarrow \hat{x}(k)$
\item Design state-feedback $u(k) = F x(k)$ and put both together.
\end{enumerate}

\end{multicols*}
\end{document}
